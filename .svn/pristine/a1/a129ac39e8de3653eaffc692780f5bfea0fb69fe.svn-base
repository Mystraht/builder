<?php
include_once('ApplicationController.class.php');

class LanternsController extends ApplicationController
{
    public function __construct()
    {
        
    }

    public function index($params)
    {
        $userId = self::getUserIdByToken($params['token']);
        
        if (!$userId) return Utils::formatErrorMessage(ERROR_BAD_TOKEN, "Bad token");

        $data = self::getLanterns($userId);

        return json_encode([
            'data' => $data,
            'error' => false,
            'errorCode' => -1,
            'errorMessage' => ''
        ]);
    }

    public function show()
    {
        return 'show';
    }

    public function create($params)
    {
        // TODO: Vérifier que la lantern est bien une lantern valide dans le .json du placement des lanterns

        $userId = self::getUserIdByToken($params['token']);
        
        if (!$userId) return Utils::formatErrorMessage(ERROR_BAD_TOKEN, "Bad token");   

        $date = date("Y-m-d H:i:s");
        
        $request = $GLOBALS['app']['db']->prepare('INSERT INTO lantern_users VALUES (NULL, ?, ?, ?, ?, ?)');
        $request->execute(array($userId, $date, $date, $params['x'], $params['y']));

        return Utils::SuccessMessage();
    }
    
    public function update()
    {
        return 'update';
    }

    public function destroy()
    {
        return 'destroy';
    }

    /**
     * Récupère la liste des lanterns du joueurs
     */
    public static function getLanterns($userId) {
        $sql = "SELECT x, y 
                FROM lantern_users
                WHERE user_id = '" . $userId . "'";
                
        
        $result = $GLOBALS['app']['db']->fetchAll($sql);
        return $result;
    }
}

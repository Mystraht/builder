<?php
use Symfony\Component\HttpFoundation\Request;
use Silex\Application;

require_once __DIR__ . '/../app/controllers/UsersController.class.php';
require_once __DIR__ . '/../app/models/UsersModel.class.php';

$basePath = '/v1';

$UsersController = new UsersController();

$UserModel = new UserModel();

function formatErrorMessage($errorMessage) {
    return json_encode([
            'data' => '',
            'error' => true,
            'errorMessage' => $errorMessage
        ]);
}

/*
 * Main path
 */

$app->get('/', function (Request $request) use ($app, $UsersController) {
    echo $app['routes']->current()->all();
    return '';
});


/*
 * Users
 */

$app->get($basePath . '/users', function (Request $request) use ($app, $UsersController) {
    return $UsersController->index();
});

$app->get($basePath . '/users/login', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'login');

    if ($errorMessage) return formatErrorMessage($errorMessage);
    else return $UsersController->login($params);
});

$app->post($basePath . '/users/create', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'create');

    if ($errorMessage) return formatErrorMessage($errorMessage);
    else return $UsersController->create($params);
});

$app->post($basePath . '/users/createFB', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'createFB');

    if ($errorMessage) return formatErrorMessage($errorMessage);
    else return $UsersController->createFB($params);
});

$app->delete($basePath . '/users/destroy', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'destroy');

    if ($errorMessage) return formatErrorMessage($errorMessage);
    else return $UsersController->destroy($params);
});

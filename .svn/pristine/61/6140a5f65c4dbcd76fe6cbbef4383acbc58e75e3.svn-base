<?php
include_once('ApplicationController.class.php');
include_once('BuildingsController.class.php');

class ResourcesController extends ApplicationController
{
	public function __construct()
	{
		
	}
	
	public function index($params) {
		return self::getResource(addslashes($params['token']));
	}
	
	public function gold($params) {
		return self::getResource(addslashes($params['token']), 'gold');
	}
	
	public function offering($params) {
		return self::getResource(addslashes($params['token']), 'offering');
	}
	
	public function spice($params) {
		return self::getResource(addslashes($params['token']), 'spice');
	}
	
	public static function getResource($token, $resourceName = '')
	{
		$userId = self::getUserIdByToken($token);
		
		if (!$userId) return Utils::formatErrorMessage(ERROR_BAD_TOKEN, "Bad token");		

		$data;
		$error = '';
		$sql = "SELECT r_t.name, r_u.count 
				FROM resource_users AS r_u 
				INNER JOIN resource_type AS r_t
				ON r_t.id = r_u.resource_type_id
				WHERE r_u.user_id = " . $userId;
				
		if ($resourceName != '') $sql .= " AND r_t.name = '" . $resourceName . "'";
		
		$result = $GLOBALS['app']['db']->fetchAll($sql);
		
		if (count($result) <= 0) $error = "Imposible de récupérer la ressource " . $resourceName . " pour le userId : " . $userId;
		else {
			for ($i = 0; $i < count($result); $i++) {
				if ($resourceName == '') $data[$result[$i]['name']] = $result[$i]['count'];
				else $data = $result[0]['count'];
			}
		}
		
		return json_encode([
			'data' => $data,
			'error' => $error != '',
			'errorCode' => -1,
			'errorMessage' => $error
		]);
	}
	
	/*
	 *
	 */
	private static function getBuildingCount($userId, $buildingName, $lvl = 0)
	{
		$buildingTypeId = BuildingsController::getBuildingTypeIdByName($buildingName);
		$table_name = "building_" . $buildingName;
		
		$sql = "SELECT count(*)
				FROM building_users AS b_u
				INNER JOIN " . $table_name . " AS b_t
					ON b_u.building_id = b_t.id
				WHERE b_u.user_id = " . $userId;
				
		if ($lvl > 0) $sql .= " AND b_t.lvl = " . $lvl;
		
		$result = $GLOBALS['app']['db']->fetchAll($sql);
		return $result[0]['count(*)'];
	}


	/*
	 * Permet d'update les ressources d'un joueur en fonction de ses bonus/batiments et de leur dernière update
	 * @param userId id de l'user pour update les resources
	 */
	public static function updateResource($userId)
	{
		$buildingGain = file_get_contents(__DIR__ . "./../../../assets/json/buildingGain.json", FILE_USE_INCLUDE_PATH);
		$buildingGain = json_decode($buildingGain);
		
		$hourGain = 0;
		
		foreach ($buildingGain as $key => $value)
		{
			if (is_int($value)) 
			{
				$hourGain += self::getBuildingCount($userId, $key) * $value;
			}
			else {
				foreach ($value as $lvl => $gain) {
					$hourGain += self::getBuildingCount($userId, $key, $lvl) * $gain;
				}
			}
		}
		
		$sql = "SELECT updated_at, count
				FROM resource_users AS r_u
				INNER JOIN resource_type AS r_t
					ON r_u.resource_type_id = r_t.id
				WHERE r_t.name = 'gold'
					AND r_u.user_id = " . $userId;
					
		$result = $GLOBALS['app']['db']->fetchAll($sql);
		
		$count = $result[0]['count'];
		$lastUpdate = new DateTime($result[0]['updated_at']);
		
		$date = new DateTime('now');
		
		$diff = $lastUpdate->diff($date);
		
		//Nombre d'heure depuis la dernière update précis à la seconde
		$diff = $diff->format('%a') * 24 + $diff->format('%h') + $diff->format('%i') / 60 + $diff->format('%s') / 3600;
		
		$newValue = $hourGain * $diff + $count;
		
		$sql = "UPDATE resource_users
		SET count = " . $newValue . ",
			updated_at = '" . $date->format("Y-m-d H:i:s") . "'
		WHERE user_id = " . $userId . "
			AND resource_type_id = 1";
		
		$result = $GLOBALS['app']['db']->exec($sql);
	}
	
	/*
	 * Ajoute de la resource a un joueur
	 * @param $resourceId l'id de la ressource à modifier
	 * @param $count le nombre de ressource a ajouter
	 * @param $userId l'id de l'utilisateur
	*/
	public static function addResource($resourceId, $count, $userId)
	{
		$sql = "SELECT updated_at, count
			FROM resource_users AS r_u
			INNER JOIN resource_type AS r_t
				ON r_u.resource_type_id = r_t.id
			WHERE r_t.id = " . $resourceId . "
				AND r_u.user_id = " . $userId;
					
		$result = $GLOBALS['app']['db']->fetchAll($sql);
		
		$newValue = $result[0]['count'] + $count;
		
		$sql = "UPDATE resource_users
		SET count = " . $newValue . ",
			updated_at = '" . date("Y-m-d H:i:s") . "'
		WHERE user_id = " . $userId . "
			AND resource_type_id = " . $resourceId;
			
		$result = $GLOBALS['app']['db']->exec($sql);
	}
	
		/*
	 * Retire de la resource a un joueur
	 * @param $resourceId l'id de la ressource à modifier
	 * @param $count le nombre de ressource a retirer
	 * @param $userId l'id de l'utilisateur
	*/
	public static function spendResource($resourceId, $count, $userId)
	{
		$sql = "SELECT updated_at, count
			FROM resource_users AS r_u
			INNER JOIN resource_type AS r_t
				ON r_u.resource_type_id = r_t.id
			WHERE r_t.id = " . $resourceId . "
				AND r_u.user_id = " . $userId;
					
		$result = $GLOBALS['app']['db']->fetchAll($sql);
		
		$newValue = $result[0]['count'] - $count;
		
		$sql = "UPDATE resource_users
		SET count = " . $newValue . ",
			updated_at = '" . date("Y-m-d H:i:s") . "'
		WHERE user_id = " . $userId . "
			AND resource_type_id = " . $resourceId;
			
		$result = $GLOBALS['app']['db']->exec($sql);
	}
	
}

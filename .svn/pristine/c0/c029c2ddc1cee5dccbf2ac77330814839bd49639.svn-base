<?php
include_once('ApplicationController.class.php');

class UsersController extends ApplicationController
{
    public function __construct()
    {
        
    }

    public function index()
    {
        return 'hello world index';
    }

    public function login($params)
    {
        $data = '';
        $error = '';
        $sql = "SELECT token FROM users WHERE username='" . addslashes($params['username']) . "' AND password='" . addslashes($params['password']) . "'";
        $result = $GLOBALS['app']['db']->fetchAll($sql);

        if(count($result) == 0) {
            $error = "Le nom d'utilisateur et le mot de passe ne correspondent pas.";
        } else {
            $data = $result[0]['token'];
        }

        return json_encode([
            'data' => $data,
            'error' => $error != '',
            'errorMessage' => $error
        ]);
    }

    public function create($params)
    {
        $date = date("Y-m-d H:i:s");
        $token = bin2hex(openssl_random_pseudo_bytes(215));
        $request = $GLOBALS['app']['db']->prepare('INSERT INTO users VALUES (NULL, ?, ?, ?, ?, NULL, NULL, ?)');
        $request->execute(array($date, $date, addslashes($params['username']), addslashes($params['password']), $token));

        return json_encode([
            'data' => $token,
            'error' => false,
            'errorMessage' => ''
        ]);
    }

    public function createFB($params)
    {
        $date = date("Y-m-d H:i:s");
        $request = $GLOBALS['app']['db']->prepare('INSERT INTO users VALUES (NULL, ?, ?, NULL, NULL, ?, ?, ?)');
        $request->execute(array($date, $date, addslashes($params['mail']), 1, addslashes($params['token'])));

        return json_encode([
            'data' => 'success',
            'error' => false,
            'errorMessage' => ''
        ]);
    }

    public function destroy($params) {
        $userId = $this->getUserIdByToken(addslashes($params['token']));

        $request = $GLOBALS['app']['db']->prepare('DELETE FROM users WHERE id="' . $userId . '";');
        $request->execute();

        if (!$userId) {
            return json_encode([
                'data' => '',
                'error' => true,
                'errorMessage' => 'Bad token'
            ]);
        }

        return json_encode([
            'data' => 'success',
            'error' => false,
            'errorMessage' => ''
        ]);
    }
}

<?php
use Symfony\Component\HttpFoundation\Request;
use Silex\Application;

require_once __DIR__ . '/../app/controllers/UsersController.class.php';
require_once __DIR__ . '/../app/models/UserModel.class.php';
require_once __DIR__ . '/../Utils.class.php';
require_once __DIR__ . '/../app/models/ResourceModel.class.php';
require_once __DIR__ . '/../app/controllers/ResourcesController.class.php';
require_once __DIR__ . '/../app/models/BuildingModel.class.php';
require_once __DIR__ . '/../app/controllers/BuildingsController.class.php';

$basePath = '/v1';

$UsersController = new UsersController();
$ResourcesController = new ResourcesController();
$BuildingsController = new BuildingsController();

$UserModel = new UserModel();
$ResourceModel = new ResourceModel();
$BuildingModel = new BuildingModel();

/*
 * Main path
 */

$app->get('/', function (Request $request) use ($app, $UsersController) {
    return $app->redirect('doc/index.html');
});


/*
 * Users
 */

$app->get($basePath . '/users', function (Request $request) use ($app, $UsersController) {
    return $UsersController->index();
});

$app->get($basePath . '/users/login', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'login');

    if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
    else return $UsersController->login($params);
});

$app->post($basePath . '/users/create', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'create');

    if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
    else return $UsersController->create($params);
});

$app->post($basePath . '/users/createFB', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'createFB');
	
    if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
    else return $UsersController->createFB($params);
});

$app->delete($basePath . '/users/destroy', function (Request $request) use ($app, $UsersController, $UserModel) {
    $params = $request->query->all();
    $errorMessage = $UserModel->validate($params, 'destroy');

    if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
    else return $UsersController->destroy($params);
});



/*
 * Resources
 */

$app->get($basePath . '/resources', function (Request $request) use ($app, $ResourcesController, $ResourceModel) {
	$params = $request->query->all();
	$errorMessage = $ResourceModel->validate($params);
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $ResourcesController->index($params);
});

$app->get($basePath . '/resources/offering', function (Request $request) use ($app, $ResourcesController, $ResourceModel) {
	$params = $request->query->all();
	$errorMessage = $ResourceModel->validate($params);
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $ResourcesController->offering($params);
});

$app->get($basePath . '/resources/gold', function (Request $request) use ($app, $ResourcesController, $ResourceModel) {
	$params = $request->query->all();
	$errorMessage = $ResourceModel->validate($params);
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $ResourcesController->gold($params);
});

$app->get($basePath . '/resources/spice', function (Request $request) use ($app, $ResourcesController, $ResourceModel) {
	$params = $request->query->all();
	$errorMessage = $ResourceModel->validate($params);
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $ResourcesController->spice($params);
});


/*
 * Buildings
 */

$app->get($basePath . '/buildings', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
    $params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "index");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->index($params);
});

$app->post($basePath . '/buildings/motel/create', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
    $params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "create");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->createMotel($params);
});

$app->post($basePath . '/buildings/temple/create', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
	$params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "create");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->createTemple($params);
});

$app->post($basePath . '/buildings/rocket_factory/create', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
	$params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "create");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->createRocketFactory($params);
});

$app->post($basePath . '/buildings/move', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
	$params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "move");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->move($params);
});

$app->post($basePath . '/buildings/collect', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
	$params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "collect");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->collect($params);
});

$app->delete($basePath . '/buildings/destroy', function (Request $request) use ($app, $BuildingsController, $BuildingModel) {
	$params = $request->query->all();
	$errorMessage = $BuildingModel->validate($params, "destroy");
	
	if ($errorMessage) return Utils::formatErrorMessage(ERROR_BAD_MODEL, $errorMessage);
	else return $BuildingsController->destroy($params);
});
